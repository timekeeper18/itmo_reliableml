## Дизайн ML системы - Dentist AI v0.1

*Шаблон ML System Design Doc от телеграм-канала [Reliable ML](https://t.me/reliable_ml)*   

- Рекомендации по процессу заполнения документа (workflow) - [здесь](https://github.com/IrinaGoloshchapova/ml_system_design_doc_ru/blob/main/ML_System_Design_Doc_Workflow.md).  
- Детальный доклад о том, что такое ML System Design Doc и о том, как, когда и зачем его составлять - [тут](https://www.youtube.com/watch?v=PW9TGNr1Vqk).
    
> ## Термины и пояснения
> - Итерация - это все работы, которые совершаются до старта очередного пилота  
> - БТ - бизнес-требования 
> - EDA - Exploratory Data Analysis - исследовательский анализ данных  
> - `Product Owner`,  `Data Scientist` - роли, которые заполняют соответствующие разделы 
> - В этом шаблоне роль `Data Scientist` совмещает в себе компетенции классического `Data Scientist` с упором на исследования и `ML Engineer` & `ML Ops` роли с акцентом на продуктивизацию моделей
> - Для вашей организации распределение ролей может быть уточнено в зависимости от операционной модели 

### 1. Цели и предпосылки 
#### 1.1. Зачем идем в разработку продукта?  

- Бизнес-цель: разработать сервис по обнаружению видимого кариеса на фотографиях зубов (челюсти), сделанных с помощью камеры мобильного телефона. Добиться полноты (Recall) обнаружения кариеса не менее 79%. 
Дополнительно (по возможности): обеспечить сегментацию и вычисление процента видимого поражения зуба.<br>
ML метрика recall взята потому, что с точки зрения пользователя нам важно отловить кариес на ранних стадиях, когда его можно лечить довольно легко, а само лечение обходится в разы дешевле, чем на поздних стадиях.<br>
Если рассматривать монетизацию не через подписку, а через партнерство с клиниками, то метрика - это количество посещений пациентами клиники после нашей рекомендации. Здесь тоже  recall подходит - при малейших подозрениях надо провериться, что увеличивает поток пациентов
- Почему станет лучше, чем сейчас, от использования ML: пользователи смогут удобно контролировать состояние своих зубов даже в случае отсутствия возможности посетить стоматолога (страх, высокая стоимость, отсутствие записи, ничего не беспокоит), получать рекомендации о посещении специалиста уже на ранних этапах развития кариеса.

#### 1.2. Бизнес-требования и ограничения  
##### Требования и ограничения:
1. Определять наличие/подозрения на кариес по фотографии зубов
2. Модель должна работать с фотографиями, сделанными на камеру современного (2-3 года) смартфона. **подумать над ограничениями на смартфоны**
3. Наличие малейшего подозрения на кариес сопровождается рекомендацией обратиться к врачу
4. Скорость работы сервиса не должно превышать 5 сек (время замеряется на клиенте)
5. На стадии POC фото загружаются по одному за раз

##### Общая логика работы:
На стадии POC рассматривается схема с "тонким" клиентом.
В качестве интерфейсной части выступает web-страница, на которой есть возможность загрузить изображение зубов и получить обработанное изображение.
На изображении будут выделены те участки зубов, на которых модель подозревает кариес, а так же рекомендацию консультации у стоматолога. 
##### Что будем считать успехом итерации?
Успехом итерации будем считать работающую модель, позволяющую по фотографии челюсти (нижней/верхней) получить ограничивающие прямоугольники, выделяющие участки с кариесом.
##### Описание бизнес-процесса пилота
Основой БП пилота будет контроль результатов со стороны дипломированного специалиста и будет состоять из следующих шагов:
1. Подбор и анализ данных
2. Формирование train/test/val выборок и очистка датасета
3. Выбор целевой метрики
4. Создание сервиса
5. Визуальный контроль со стороны дипломированного специлиста

#### 1.3. Возможные пути развития проекта:
1. Перенос UI в приложение для смартфона
2. Возможность анализировать несколько изображений с разных ракурсов и выдавать взвешенную оценку
3. Умение различать взрослую и детскую челюсти и выдавать рекомендации с учетом этого
4. Умение диференцировать различные стадии кариеса
5. Расширение набора классов детекции, т.е. зубных болезней 
6. Создание личного кабинета пользователя с историей загрузок, данными о личном стоматологе или клинике 
7. Онлан консультация/верификация у стоматолога 
8. Запись в стоматологию через приложение 
9. Проработка нескольких путей монетизации:
   1. Пользовательская подписка
   2. Партнерская программа с клиникой
   3. SaaS продажа услуг клиникам для встраивания в их приложения
   4. Комбинированный: подписка на сервис предоставляет скидку на посещение клиники, при условии записи через приложение

### 2. Стек технологий
- Среда:
  - Разработка на ПК участников проекта + ресурсы colab
  - Развертывание: на dev-сервере Intel(R) Core(TM) i5-7400 CPU @ 3.00GHz, 15GB RAM, GeForce RTX 2060 Rev.A (5934MiB)
- Стэк-технологий: Python, FastAPI, pytorch, Wandb, YOLO
- Данные: для текущей итерации использовались открытые данные с соревнований kaggle, данные с roboflow.com:

| Ресурс     | Ссылка на датасет                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| roboflow.com | [caries-e8k9g](https://universe.roboflow.com/school-waoxh/caries-e8k9g)<br/><br/>[dataset/1](https://universe.roboflow.com/college-gl4rb/norma-l/dataset/1)[tteth](https://universe.roboflow.com/k-nybrl/tteth)<br/>[dental-disease-detection-xqalp](https://universe.roboflow.com/rizka-milandga-2k04u/dental-disease-detection-xqalp)<br/>[our](https://universe.roboflow.com/111-j3wer/our)<br/>[yolo-conversion-fbsju](https://universe.roboflow.com/yolo-lgmeg/yolo-conversion-fbsju)<br/>[toothcaries](https://universe.roboflow.com/odontoapp/toothcaries)<br/>[xd_2](https://universe.roboflow.com/111-j3wer/xd_2)<br/>[proyecto-deteccion-de-enfermedades-dentales](https://universe.roboflow.com/proyecto-odontologia/proyecto-deteccion-de-enfermedades-dentales)<br/>[caries-scjtb](https://universe.roboflow.com/vitekthebest/caries-scjtb)<br/>[mega-thoart-data](https://universe.roboflow.com/vitekthebest/mega-thoart-data/)<br/>[dentasis](https://universe.roboflow.com/dentasis/dentasis)<br/>[dental-project-bvtip](https://universe.roboflow.com/dental-project-fcai/dental-project-bvtip)<br/>[occlusal-caries-detection-olf03](https://universe.roboflow.com/predict-caries-1/occlusal-caries-detection-olf03/)<br/> [caries-detection-euzne](https://universe.roboflow.com/digital-health-bg/caries-detection-euzne) <br/> [dental-app](https://universe.roboflow.com/dental-app/dental-app) |
|      kaggle.com      | [teeth-dataset](https://www.kaggle.com/datasets/pushkar34/teeth-dataset)<br/>[oral-diseases](https://www.kaggle.com/datasets/salmansajid05/oral-diseases)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|     zenodo.org       | [record/4907880](https://zenodo.org/record/4907880)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |

- **Регуляторные, complience и privacy ограничения** - ???
#### 2.1. Что входит в скоуп проекта/итерации, что не входит   

- Будет закрыто: Создание web-сервиса, позволяющего подтвердить гипотезу, что возможно с приемлемым качеством обнаруживать кариес на снимках со смартфона.
- Что не будет закрыто: Создание мобильного приложения, классификация различных степеней кариеса, ведение истории наблюдений, классификация различных заболеваний полости рта. 

#### 2.2. Предпосылки решения  
1) Желание дома контролировать состояние своих зубов/зубов своих детей
2) Отсутсвие вуремени часто иходить к стоматологу 
3) Наличие открытых датасетов по кариесу 
4) Модели семейства YOLO достаточно быстрые и часто используются для задач детекции. Хороший вариант для бейзлайна.


### 3. Методология

#### 3.1. Постановка задачи  
V1.0:
1. Обученная модель по детекции на фото областей зубов с кариесом: 1 класс "Кариес"
2. Веб API для инференса модели
3. Web UI для проверки работы на пользовательском уровне
4. Входные данные: rgb-изображение в формате png/jpg, сделанные пользователем на камеру своего смартфона
5. Выходные данные: rgb-изображение с наложенными ограничивающими рамками указывающими на участки с подозрением на кариес


#### 3.2. Блок-схема решения  

Подготовка решения состоит из 7и основных этапов:
- ЭТАП 0. Исследовательский: поиск и изучение данных, изучение методов диагностики кариеса
- ЭТАП 1. EDA - анализ и очистка данных, формирование датасета
- ЭТАП 2. Обучение моделей
- ЭТАП 3. Тестирование моделей и оценка результатов (возврат к ЭТАПАМ 1, 2)
- ЭТАП 4. Подготовка к инференсу: анализ скоростных характеристик, исследование возможностей по ускорению/уменьшению модели
- ЭТАП 5. Подготовка инференса: создание API, интерфейсав, классов по использованию модели
- ЭТАП 6. Тестирование и отладака: тестирование приложения как разработчиками, так и экспертами и пользователями

![Блок-схема решения](schema.jpeg)

#### 3.3. Этапы решения задачи `Data Scientist`  
   
**Этап 1 - поиск, выбор и анализ датасетов, подготовка данных для обучения моделей.**

Требования к данным:
Фотографии открытого рта, так чтобы были видны зубы верхней или нижней челюсти (или обеих сразу). Качество фото должно быть такого уровня
чтобы визуально можно было разглядеть зубы и их дефекты, если они есть.
В качестве основного источника данных было принято решение использовать ресурс roboflow. Так как только там имелись данные в необходимом количестве.
На roboflow было проанализировано большое количество открытых датасетов. Часть из них была признана потенциально пригодными для использования.  

| Название датасета              | Ссылка на датасет                                                                              | Размер датасета | Описание                                                             | Подходит?                                                                                                                 |
|--------------------------------|------------------------------------------------------------------------------------------------|-----------------|----------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------|
| dental-app                     | https://universe.roboflow.com/dental-app/dental-app                                            | 32/167          | Кариес, диастемы, пятна и т.д.                                       | Только, как вспомогательный набор. Требуется полная переразметка                                                          |
| occlusal-caries-detection      | https://universe.roboflow.com/predict-caries-1/occlusal-caries-detection-olf03/                | 56/61           | Кариес.                                                              | Только, как вспомогательный набор. Требуется полная переразметка                                                          |
| dental-project-bvtip           | https://universe.roboflow.com/dental-project-fcai/dental-project-bvtip                         | 463/1691        | Кариес, гингивит, абсцесс и т.д. Без меток 0                         | Нет. Слишком крупный план съемок.                                                                                         |
| dentasis                       | https://universe.roboflow.com/dentasis/dentasis                                                | 509/1129        | Кариес 2 вида  без меток 612                                         | Подойдёт. Наиболее адекватный датасет из всех, что приходилось смотреть. Но нужна будет чистка и переразметка.            |
| mega-throat-data               | https://universe.roboflow.com/vitekthebest/mega-thoart-data/                                   | 544/1864        | Кариес. Без меток 0 есть метки зубов (детские фото)                  | Только, как вспомогательный набор. Придётся переразмечать                                                                 |
| caries-scjtb                   | https://universe.roboflow.com/vitekthebest/caries-scjtb                                        | 296/410         | Кариес. Без меток 4. Есть метки зубов (детские фото)                 | Нет. Придётся чистить и удалять большую часть данных. То, что осталось придётся переразмечать.                            |
| deenfermedades-dental          | https://universe.roboflow.com/proyecto-odontologia/proyecto-deteccion-de-enfermedades-dentales | 76/204          | Кариес, язвы во рту. Без меток 4 (yolo8 нет)                         | Разметка под сегментацию. Придется чистить и полностью переразмечать                                                      |
| xd_2                           | https://universe.roboflow.com/111-j3wer/xd_2                                                   | 448/900         | Кариес. Без меток 452 фото. (детские фото)                           | Только, как вспомогательный набор. Придётся чистить и переразмечать                                                       |
| toothcaries                    | https://universe.roboflow.com/odontoapp/toothcaries                                            | 201/201         | Кариес (yolo8 нет)                                                   | Разметка под сегментацию. Придется полностью переразмечать                                                                |
| yolo-convertion-fbsju          | https://universe.roboflow.com/yolo-lgmeg/yolo-conversion-fbsju                                 | 424             | Кариес, пломбы, коронки и т.д.                                       | Частично. Придётся чистить и переразмечать                                                                                |
| 111-j3wer                      | https://universe.roboflow.com/111-j3wer/our                                                    | 56              | только кариес (детские фото)                                         | Только, как вспомогательный набор. Придётся переразмечать                                                                 |
| dentasis v30                   | https://universe.roboflow.com/dentasisv30/dental_caries_detection_2/                           | 476             | Кариес. Очищенная версия dentasis                                    | Датасет взят в качестве базового для проведения экспериментов по обучению моделей                                         |
| dental-disease-detection       | https://universe.roboflow.com/rizka-milandga-2k04u/dental-disease-detection-xqalp              | 43/204          | Кариес                                                               | Только, как вспомогательный набор. Придётся переразмечать                                                                 |
| dentasis_dental_disease_occlus | https://universe.roboflow.com/dentasisv30/dentasis_dental_disease_occlus/                      | 575             | Кариес. Объединение трех очищенных и частично размеченных датасетов. | Подходит. Этот набор был создан, как объединение трёх других.                                                             |
| tteth                          | https://universe.roboflow.com/k-nybrl/tteth                                                    | 291             | Здоровые зубы (в основном)                                           | Подходит. После чистки оставим только фото здоровых зубов. Будем использовать, как background images, для снижения FP     |
| norma-l                        | https://universe.roboflow.com/college-gl4rb/norma-l/dataset/1                                  | 115             | Здоровые зубы (в основном)                                           | Подходит, как background images. После чистки оставим только фото здоровых зубов. Частично пересекается с датасетом tteth |
| aug dentasis_dental_disease_occlus| https://universe.roboflow.com/dentasisv30/dentasis_dental_disease_occlus/dataset/2          | 1655            | Кариес.                                                              | Аугментированный поворотами, сдвигами и отражением базовый датасет.                                                       |  

EDA показал, что данные всех датасетов очень плохо размечены, есть много неподходящих фото.
- Необходимо отобрать фотографии, на которых хорошо видны зубы и корректная разметка.
- Часть данных придётся переразметить (так как bbox меньше/больше, чем нужно либо вообще не там, где надо).

 Для перехода на следующий этап необходимо собрать датасет не менее:

 1) Для бейзлайна - до 500 изображений.
 2) Для MVP - от 500 и больше изображений.

После нескольких итераций очистки и переразметки был собран датасет, названный базовым.
Он является объединением открытых датасетов dentasisv30, Occlusal caries detection, Dental disease detection и содержит 575 фото.
Но мы считаем, что необходимо продолжить очистку, переразметку новых данных и их добавление в базовый датасет для улучшения качества работы моделей. 

Всего было собрано 8 датасетов:

| Наименование | Количество файлов | Коммментарий                                        | 
|--------------|-------------------|-----------------------------------------------------|
| dentasis_v32i_Caries_v0        | 9539              | базовый датасет: очень грязный                      |
| xd_n.v1i_Caries_v0        | 911               | эксперименты со сторонними датасетами               |
| dentasis_v30_Caries_v0         | 953               |   эксперименты со сторонними датасетами: переразметка                                                  |
| dentasis_v30_2_Caries_v0  | 953               | пересборка  dentasis_v30_Caries_v0                  |
| dentasis_v30_2_Occlus_Caries_v0| 1113              | эксперименты со сторонними датасетами: переразметка |
| dentasis_v30_3_Caries_v0         | 953               | переразметка  dentasis_v30_Caries_v0                |
| dentasis_v30_4_Dental_disease_detection_Occlus | 1151              | эксперименты со сторонними датасетами: переразметка |
| dentasis_v30_5_Dental_disease_detection_Occlus | 1178              | переразметка и добавление примеров в dentasis_v30_4_Dental_disease_detection_Occlus               |

Риски и проблемы:
1) Плохое качество фото и разметки в датасетах, загрязненные данные (невалидные фото).
2) На очистку и переразметку датасетов уходит очень много времени.
3) Скорость инференса.
4) Аппаратные средства при обучении: ограничения видеокарты влияюит на размер батча

**Этап 2 - разработка пайплайна загрузки и аугментации изображений**

- Работа с датасетом: формирование датасета, его разметка, аугментация, добавление и удаление примеров велась на [roboflow](https://roboflow.com/)
- Архитектура: YOLO ([Ultralytics](https://docs.ultralytics.com/)) + встроенная аугментация
- Треккинг экспериментов: [Wandb](https://wandb.ai/dentist_ai/Dentist_AI/table?workspace=user-)

1) Для бейзлайна - пока что сбор данных проводился именно для бейзлайновой модели.
2) Для MVP - требуется увеличить имеющийся базовый датасет, более точная разметка при консультции дипломрованного специалиста

**Риски и проблемы:**

1) При небольшом размере базового датасета аугментации могут не помочь в задаче увеличения качества работы модели.


**Этап 3 - обучение и сравнение моделей детекции**

В качестве бейзлайна было принято решение использовать модель YOLO5.
Также в качестве альтернативы была выбрана модель YOLO8.
Эксперименты по обучению этих моделей показали, что YOLO5 превосходила YOLO8 на несколько процентов по метрикам Precision и Recall.

Таблица сравнения моделей:

| Модель  |  Precision | Recall    | 
|---------|------------|-----------|
| YOLO5   | 0.521      |  0.432    |
| YOLO8   | 0.456      |  0.368    | 

1) Бейзлайн - YOLO5.
2) MVP - скорее всего будет тоже YOLO5.

**Этап 4 - подготовка инференса модели**

В рамках подготовки инференса был создан пайплайн для конвертации весов модели из формата pt в формат ONNX.
А также пайплайн загрузки и инференса модели в формате ONNNX. 

1) Бейзлайн - ONNX формат.
2) MVP - ONNX формат.

Описание техники **для каждого этапа** должно включать описание **отдельно для MVP** и **отдельно для бейзлайна**:  

- Описание формирования выборки для обучения, тестирования и валидации. Выбор репрезентативных данных для экспериментов, обучения и подготовки пилота (от бизнес-цели и репрезентативности данных с технической точки зрения) `Data Scientist`    
- Горизонт, гранулярность, частоту необходимого пересчета прогнозных моделей `Data Scientist`   
- Определение целевой переменной, согласованное с бизнесом `Data Scientist`   
- Какие метрики качества используем и почему они связаны с бизнес-результатом, обозначенным `Product Owner` в разделах `1` и `3`. Пример - WAPE <= 50% для > 80% категорий, bias ~ 0. Возможна формулировка в терминах относительно бейзлайна, количественно. Для бейзлайна могут быть свои целевые метрики, а может их вообще не быть (если это обосновано) `Data Scientist`   
- Необходимый результат этапа. Например, необходимым результатом может быть не просто достижение каких-либо метрик качества, а включение в модели определенных факторов (флаг промо для прогноза выручки, др.) `Data Scientist`    
- Какие могут быть риски и что планируем с этим делать. Например, необходимый для модели фактор (флаг промо) окажется незначимым для большинства моделей. Или для 50% моделей будет недостаточно данных для оценки `Data Scientist`    
- Верхнеуровневые принципы и обоснования для: feature engineering, подбора алгоритма решения, техники кросс-валидации, интерпретации результата (если применимо).  
- Предусмотрена ли бизнес-проверка результата этапа и как будет проводиться `Data Scientist` & `Product Owner`  
  
### 4. Подготовка пилота  
  
#### 4.1. Способ оценки пилота  
  
Оценка пилота происходит в несколько стадий:
1. Автоматические тесты с применением кроспроверок и строгим вылелением test-выборки
2. Визуальный контроль со стороны дипломированного специлиста
  
#### 4.2. Что считаем успешным пилотом  
  
Успехом пилота будем считать работающий сервис с возможностью загрузить фотографию челюсти (нижней/верхней) и получить ответ об обнаружении на снимке кариеса с необходимой полнотой обнаружения.
Пользователь сможет получить первые результаты работы сервиса и обратиться к врачу по списку клиник, занесенному в сервис заранее (в пределах одного города)
  
#### 4.3. Подготовка пилота  
  
- Что можем позволить себе, исходя из ожидаемых затрат на вычисления. Если исходно просчитать сложно, то описываем этап расчетов ожидаемой вычислительной сложности на эксперименте с бейзлайном. И предусматриваем уточнение параметров пилота и установку ограничений по вычислительной сложности моделей. `Data Scientist` 

### 4. Внедрение `для production систем, если требуется`    

> Заполнение раздела 4 требуется не для всех дизайн документов. В некоторых случаях результатом итерации может быть расчет каких-то значений, далее используемых в бизнес-процессе для пилота.  
  
#### 4.1. Архитектура решения   
  
- Блок схема и пояснения: сервисы, назначения, методы API `Data Scientist`  
  
#### 4.2. Описание инфраструктуры и масштабируемости 
  
- Какая инфраструктура выбрана и почему `Data Scientist` 
- Плюсы и минусы выбора `Data Scientist` 
- Почему финальный выбор лучше других альтернатив `Data Scientist` 
  
#### 4.3. Требования к работе системы  
  
- SLA, пропускная способность и задержка `Data Scientist`  
  
#### 4.4. Безопасность системы  
  
- Потенциальная уязвимость системы `Data Scientist`  
  
#### 4.5. Безопасность данных   
  
- Нет ли нарушений GDPR и других законов `Data Scientist`  
  
#### 4.6. Издержки  
  
- Расчетные издержки на работу системы в месяц `Data Scientist`  
  
#### 4.5. Integration points  
  
- Описание взаимодействия между сервисами (методы API и др.) `Data Scientist`  
  
#### 4.6. Риски  
  
- Описание рисков и неопределенностей, которые стоит предусмотреть `Data Scientist`   
  
> ### Материалы для дополнительного погружения в тему  
> - [Шаблон ML System Design Doc [EN] от AWS](https://github.com/eugeneyan/ml-design-docs) и [статья](https://eugeneyan.com/writing/ml-design-docs/) с объяснением каждого раздела  
> - [Верхнеуровневый шаблон ML System Design Doc от Google](https://towardsdatascience.com/the-undeniable-importance-of-design-docs-to-data-scientists-421132561f3c) и [описание общих принципов его заполнения](https://towardsdatascience.com/understanding-design-docs-principles-for-achieving-data-scientists-53e6d5ad6f7e).
> - [ML Design Template](https://www.mle-interviews.com/ml-design-template) от ML Engineering Interviews  
> - Статья [Design Documents for ML Models](https://medium.com/people-ai-engineering/design-documents-for-ml-models-bbcd30402ff7) на Medium. Верхнеуровневые рекомендации по содержанию дизайн-документа и объяснение, зачем он вообще нужен  
> - [Краткий Canvas для ML-проекта от Made with ML](https://madewithml.com/courses/mlops/design/#timeline). Подходит для верхнеуровневого описания идеи, чтобы понять, имеет ли смысл идти дальше.  
