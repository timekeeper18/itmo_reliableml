# ML System Design Doc - [RU]
## Дизайн ML системы - Dentist AI v0.1

*Шаблон ML System Design Doc от телеграм-канала [Reliable ML](https://t.me/reliable_ml)*   

- Рекомендации по процессу заполнения документа (workflow) - [здесь](https://github.com/IrinaGoloshchapova/ml_system_design_doc_ru/blob/main/ML_System_Design_Doc_Workflow.md).  
- Детальный доклад о том, что такое ML System Design Doc и о том, как, когда и зачем его составлять - [тут](https://www.youtube.com/watch?v=PW9TGNr1Vqk).
    
> ## Термины и пояснения
> - Итерация - это все работы, которые совершаются до старта очередного пилота  
> - БТ - бизнес-требования 
> - EDA - Exploratory Data Analysis - исследовательский анализ данных  
> - `Product Owner`,  `Data Scientist` - роли, которые заполняют соответствующие разделы 
> - В этом шаблоне роль `Data Scientist` совмещает в себе компетенции классического `Data Scientist` с упором на исследования и `ML Engineer` & `ML Ops` роли с акцентом на продуктивизацию моделей
> - Для вашей организации распределение ролей может быть уточнено в зависимости от операционной модели 

### 1. Цели и предпосылки 
#### 1.1. Зачем идем в разработку продукта?  

- Бизнес-цель: разработать сервис по обнаружению видимого кариеса на фотографиях зубов (челюсти), сделанных с помощью камеры мобильного телефона. Добиться полноты (Recall) обнаружения кариеса не менее 79%. 
Дополнительно (по возможности): обеспечить сегментацию и вычисление процента видимого поражения зуба.
- Почему станет лучше, чем сейчас, от использования ML: пользователи смогут удобно контролировать состояние своих зубов даже в случае отсутствия возможности посетить стоматолога (страх, высокая стоимость, отсутствие записи, ничего не беспокоит), получать рекомендации о посещении специалиста уже на ранних этапах развития кариеса.

#### 1.2. Бизнес-требования и ограничения  

- Общая логика работы: 
Система работает как веб-сервис. По адресу сайта системы у пользователя есть возможность загрузить фотографию. В ответ система выдает полученное изображение с выделением участков зубов, где обнаружен кариес, а так же рекомендацию консультации у стоматолога. 
- Бизнес-требования:
модель должна работать с фотографиями, сделанными на камеру современного (2-3 года) смартфона. **подумать над ограничениями на смартфоны**
- Бизнес-ограничения: 
1) После загрузки фото на сайте системы, ответ с результатами детекции должен приходить не дольше, чем через 5 секунд.
2) На текущий момент фото загружаются по одному за раз.
- Что будем считать успехом итерации?
Успехом итерации будем считать работающий MVP с возможностью загрузить фотографию челюсти (нижней/верхней) и получить ответ об обнаружении на снимке кариеса с необходимой полнотой обнаружения.
- Описание бизнес-процесса пилота, насколько это возможно - как именно мы будем использовать модель в существующем бизнес-процессе? **описать процесс фотографирования (ракурс и т.п.)  
- Возможные пути развития проекта:
Загрузка нескольких фото за один раз, классификация различных степеней кариеса, оценка процентов видимого поражения зуба, ведение истории наблюдений и отслеживание состояния зубов в динамике, обнаружение других заболеваний полости рта.
- Среда: разработка на личных компьютерах, развертывание в облачном сервере.
- Стэк-технологий: Python, FastAPI, pytorch, Wandb.
- Данные: для текущей итерации открытые данные с соревнований kaggle, данные с roboflow.com:

https://universe.roboflow.com/school-waoxh/caries-e8k9g

https://universe.roboflow.com/digital-health-bg/caries-detection-euzne

https://www.kaggle.com/datasets/pushkar34/teeth-dataset

https://zenodo.org/record/4907880

https://www.kaggle.com/datasets/salmansajid05/oral-diseases

https://universe.roboflow.com/dental-app/dental-app

https://universe.roboflow.com/predict-caries-1/occlusal-caries-detection-olf03/

https://universe.roboflow.com/dental-project-fcai/dental-project-bvtip

https://universe.roboflow.com/dentasis/dentasis

https://universe.roboflow.com/vitekthebest/mega-thoart-data/

https://universe.roboflow.com/vitekthebest/caries-scjtb

https://universe.roboflow.com/proyecto-odontologia/proyecto-deteccion-de-enfermedades-dentales

https://universe.roboflow.com/111-j3wer/xd_2

https://universe.roboflow.com/odontoapp/toothcaries

https://universe.roboflow.com/yolo-lgmeg/yolo-conversion-fbsju

https://universe.roboflow.com/111-j3wer/our

https://universe.roboflow.com/rizka-milandga-2k04u/dental-disease-detection-xqalp

https://universe.roboflow.com/k-nybrl/tteth

https://universe.roboflow.com/college-gl4rb/norma-l/dataset/1

- **Регуляторные, complience и privacy ограничения** - ???
#### 1.3. Что входит в скоуп проекта/итерации, что не входит   

- Будет закрыто: Создание MVP, тестирование гипотезы, что возможно с приемлемым качеством обнаруживать кариес на снимках со смартфона.
- Что не будет закрыто: Создание мобильного приложения, классификация различных степеней кариеса, ведение истории наблюдений, классификация различных заболеваний полости рта. 

#### 1.4. Предпосылки решения  

- Описание всех общих предпосылок решения, используемых в системе: какие блоки данных используем, горизонт прогноза, гранулярность модели, и др.

1) В наличии есть открытые датасеты по кариесу.
2) Модели семейства YOLO достаточно быстрые и часто используются для задач детекции. Хороший вариант для бейзлайна.


### 2. Методология

#### 2.1. Постановка задачи  

- Что делаем с технической точки зрения: V1.0 - детекция объектов на изображении.

Создание модели для задачи детекции областей зубов с кариесом.
Входные данные для модели: rgb изображения (фотографии, сделанные пользователем с помощью смартфона).

Выходные данные модели: rgb изображения с наложенными ограничивающими рамками после детекции участков зубов с кариесом.

#### 2.2. Блок-схема решения  

- Блок-схема для бейзлайна и основного MVP с ключевыми этапами решения задачи: подготовка данных, построение моделей, оптимизация, тестирование, закрытие технического долга, подготовка пилота, другое. `Data Scientist`  
![Блок-схема решения](schema.jpeg)

#### 2.3. Этапы решения задачи `Data Scientist`  
   
**Этап 1 - поиск, выбор и анализ датасетов, подготовка данных для обучения моделей.**

Требования к данным:
Фотографии открытого рта, так чтобы были видны зубы верхней или нижней челюсти (или обеих сразу). Качество фото должно быть такого уровня
чтобы визуально можно было разглядеть зубы и их дефекты, если они есть.
В качестве основного источника данных было принято решение использовать ресурс roboflow. Так как только там имелись данные в необходимом количестве.
На roboflow было проанализировано большое количество открытых датасетов. Часть из них была признана потенциально пригодными для использования.  

| Название датасета              | Ссылка на датасет                                                                              | Размер датасета | Описание                                                             | Подходит?                                                                                                                 |
|--------------------------------|------------------------------------------------------------------------------------------------|-----------------|----------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------|
| dental-app                     | https://universe.roboflow.com/dental-app/dental-app                                            | 32/167          | Кариес, диастемы, пятна и т.д.                                       | Только, как вспомогательный набор. Требуется полная переразметка                                                          |
| occlusal-caries-detection      | https://universe.roboflow.com/predict-caries-1/occlusal-caries-detection-olf03/                | 56/61           | Кариес.                                                              | Только, как вспомогательный набор. Требуется полная переразметка                                                          |
| dental-project-bvtip           | https://universe.roboflow.com/dental-project-fcai/dental-project-bvtip                         | 463/1691        | Кариес, гингивит, абсцесс и т.д. Без меток 0                         | Нет. Слишком крупный план съемок.                                                                                         |
| dentasis                       | https://universe.roboflow.com/dentasis/dentasis                                                | 509/1129        | Кариес 2 вида  без меток 612                                         | Подойдёт. Наиболее адекватный датасет из всех, что приходилось смотреть. Но нужна будет чистка и переразметка.            |
| mega-throat-data               | https://universe.roboflow.com/vitekthebest/mega-thoart-data/                                   | 544/1864        | Кариес. Без меток 0 есть метки зубов (детские фото)                  | Только, как вспомогательный набор. Придётся переразмечать                                                                 |
| caries-scjtb                   | https://universe.roboflow.com/vitekthebest/caries-scjtb                                        | 296/410         | Кариес. Без меток 4. Есть метки зубов (детские фото)                 | Нет. Придётся чистить и удалять большую часть данных. То, что осталось придётся переразмечать.                            |
| deenfermedades-dental          | https://universe.roboflow.com/proyecto-odontologia/proyecto-deteccion-de-enfermedades-dentales | 76/204          | Кариес, язвы во рту. Без меток 4 (yolo8 нет)                         | Разметка под сегментацию. Придется чистить и полностью переразмечать                                                      |
| xd_2                           | https://universe.roboflow.com/111-j3wer/xd_2                                                   | 448/900         | Кариес. Без меток 452 фото. (детские фото)                           | Только, как вспомогательный набор. Придётся чистить и переразмечать                                                       |
| toothcaries                    | https://universe.roboflow.com/odontoapp/toothcaries                                            | 201/201         | Кариес (yolo8 нет)                                                   | Разметка под сегментацию. Придется полностью переразмечать                                                                |
| yolo-convertion-fbsju          | https://universe.roboflow.com/yolo-lgmeg/yolo-conversion-fbsju                                 | 424             | Кариес, пломбы, коронки и т.д.                                       | Частично. Придётся чистить и переразмечать                                                                                |
| 111-j3wer                      | https://universe.roboflow.com/111-j3wer/our                                                    | 56              | только кариес (детские фото)                                         | Только, как вспомогательный набор. Придётся переразмечать                                                                 |
| dentasis v30                   | https://universe.roboflow.com/dentasisv30/dental_caries_detection_2/                           | 476             | Кариес. Очищенная версия dentasis                                    | Датасет взят в качестве базового для проведения экспериментов по обучению моделей                                         |
| dental-disease-detection       | https://universe.roboflow.com/rizka-milandga-2k04u/dental-disease-detection-xqalp              | 43/204          | Кариес                                                               | Только, как вспомогательный набор. Придётся переразмечать                                                                 |
| dentasis_dental_disease_occlus | https://universe.roboflow.com/dentasisv30/dentasis_dental_disease_occlus/                      | 575             | Кариес. Объединение трех очищенных и частично размеченных датасетов. | Подходит. Этот набор был создан, как объединение трёх других.                                                             |
| tteth                          | https://universe.roboflow.com/k-nybrl/tteth                                                    | 291             | Здоровые зубы (в основном)                                           | Подходит. После чистки оставим только фото здоровых зубов. Будем использовать, как background images, для снижения FP     |
| norma-l                        | https://universe.roboflow.com/college-gl4rb/norma-l/dataset/1                                  | 115             | Здоровые зубы (в основном)                                           | Подходит, как background images. После чистки оставим только фото здоровых зубов. Частично пересекается с датасетом tteth |

EDA показал, что данные всех датасетов очень плохо размечены, есть много неподходящих фото.
 Необходимо отобрать фотографии на которых хорошо видны зубы и у которых корректная разметка. Часть данных придётся переразметить (так как bbox меньше/больше, чем нужно либо вообще не там, где надо).
 Для перехода на следующий этап необходимо собрать датасет не менее:

 1) Для бейзлайна - до 500 изображений.
 2) Для MVP - от 500 и больше изображений.

После нескольких итераций очистки и переразметки был собран датасет, названный базовым.
Он является объединением открытых датасетов dentasisv30, Occlusal caries detection, Dental disease detection и содержит 575 фото.
Но мы считаем, что необходимо продолжить очистку, переразметку новых данных и их добавление в базовый датасет для улучшения качества работы моделей. 

Риски и проблемы:

1) Плохое качество фото и разметки в датасетах, загрязненные данные (невалидные фото).
2) На очистку и переразметку датасетов уходит очень много времени.

**Этап 2 - разработка пайплайна загрузки и аугментации изображений**

Очистка и переразметка данных велась с помощью инструментов ресурса roboflow. Там же есть инструменты для добавления аугментаций и получения аугментированного датасета.
Кроме того, некоторые модели (например из семейства YOLO) имеют встроенные методы аугментации для их применения на лету.
Финальный датасет загружался на Wandb. И при запуске обучения он подгружался (если не был загружен ранее) из Wandb.

1) Для бейзлайна - пока что сбор данных проводился именно для бейзлайновой модели.
2) Для MVP - требуется увеличить имеющийся базовый датасет.

Риски и проблемы:

1) При небольшом размере базового датасета аугментации могут не помочь в задаче увеличения качества работы модели.


**Этап 3 - обучение и сравнение моделей детекции**

В качестве бейзлайна было принято решение использовать модель YOLO5.
Также в качестве альтернативы была выбрана модель YOLO8.
Эксперименты по обучению этих моделей показали, что YOLO5 превосходила YOLO8 на несколько процентов по метрикам Precision и Recall.

Таблица сравнения моделей:

| Модель  |  Precision | Recall    | 
|---------|------------|-----------|
| YOLO5   | 0.521      |  0.432    |
| YOLO8   | 0.456      |  0.368    | 

1) Бейзлайн - YOLO5.
2) MVP - скорее всего будет тоже YOLO5.

**Этап 4 - подготовка инференса модели**

В рамках подготовки инференса был создан пайплайн для конвертации весов модели из формата pt в формат ONNX.
А также пайплайн загрузки и инференса модели в формате ONNNX. 

1) Бейзлайн - ONNX формат.
2) MVP - ONNX формат.

> Примеры этапов:  
> - Этап 2 - Подготовка прогнозных моделей  
> - Этап 3 - Интерпретация моделей (согл. с заказчиком)  
> - Этап 4 - Интеграция бизнес правил для расчета бизнес-метрик качества мрдели  
> - Этап 5 - Подготовка инференса модели по итерациям    
> - Этап 6 - Интеграция бизнес правил  
> - Этап 7 - Разработка оптимизатора (выбор оптимальной итерации)  
> - Этап 8 - Подготовка финального отчета для бизнеса  

Описание техники **для каждого этапа** должно включать описание **отдельно для MVP** и **отдельно для бейзлайна**:  

- Описание формирования выборки для обучения, тестирования и валидации. Выбор репрезентативных данных для экспериментов, обучения и подготовки пилота (от бизнес-цели и репрезентативности данных с технической точки зрения) `Data Scientist`    
- Горизонт, гранулярность, частоту необходимого пересчета прогнозных моделей `Data Scientist`   
- Определение целевой переменной, согласованное с бизнесом `Data Scientist`   
- Какие метрики качества используем и почему они связаны с бизнес-результатом, обозначенным `Product Owner` в разделах `1` и `3`. Пример - WAPE <= 50% для > 80% категорий, bias ~ 0. Возможна формулировка в терминах относительно бейзлайна, количественно. Для бейзлайна могут быть свои целевые метрики, а может их вообще не быть (если это обосновано) `Data Scientist`   
- Необходимый результат этапа. Например, необходимым результатом может быть не просто достижение каких-либо метрик качества, а включение в модели определенных факторов (флаг промо для прогноза выручки, др.) `Data Scientist`    
- Какие могут быть риски и что планируем с этим делать. Например, необходимый для модели фактор (флаг промо) окажется незначимым для большинства моделей. Или для 50% моделей будет недостаточно данных для оценки `Data Scientist`    
- Верхнеуровневые принципы и обоснования для: feature engineering, подбора алгоритма решения, техники кросс-валидации, интерпретации результата (если применимо).  
- Предусмотрена ли бизнес-проверка результата этапа и как будет проводиться `Data Scientist` & `Product Owner`  
  
### 3. Подготовка пилота  
  
#### 3.1. Способ оценки пилота  
  
- Краткое описание предполагаемого дизайна и способа оценки пилота `Product Owner`, `Data Scientist` with `AB Group` 
  
#### 3.2. Что считаем успешным пилотом  
  
Формализованные в пилоте метрики оценки успешности `Product Owner`   
  
#### 3.3. Подготовка пилота  
  
- Что можем позволить себе, исходя из ожидаемых затрат на вычисления. Если исходно просчитать сложно, то описываем этап расчетов ожидаемой вычислительной сложности на эксперименте с бейзлайном. И предусматриваем уточнение параметров пилота и установку ограничений по вычислительной сложности моделей. `Data Scientist` 

### 4. Внедрение `для production систем, если требуется`    

> Заполнение раздела 4 требуется не для всех дизайн документов. В некоторых случаях результатом итерации может быть расчет каких-то значений, далее используемых в бизнес-процессе для пилота.  
  
#### 4.1. Архитектура решения   
  
- Блок схема и пояснения: сервисы, назначения, методы API `Data Scientist`  
  
#### 4.2. Описание инфраструктуры и масштабируемости 
  
- Какая инфраструктура выбрана и почему `Data Scientist` 
- Плюсы и минусы выбора `Data Scientist` 
- Почему финальный выбор лучше других альтернатив `Data Scientist` 
  
#### 4.3. Требования к работе системы  
  
- SLA, пропускная способность и задержка `Data Scientist`  
  
#### 4.4. Безопасность системы  
  
- Потенциальная уязвимость системы `Data Scientist`  
  
#### 4.5. Безопасность данных   
  
- Нет ли нарушений GDPR и других законов `Data Scientist`  
  
#### 4.6. Издержки  
  
- Расчетные издержки на работу системы в месяц `Data Scientist`  
  
#### 4.5. Integration points  
  
- Описание взаимодействия между сервисами (методы API и др.) `Data Scientist`  
  
#### 4.6. Риски  
  
- Описание рисков и неопределенностей, которые стоит предусмотреть `Data Scientist`   
  
> ### Материалы для дополнительного погружения в тему  
> - [Шаблон ML System Design Doc [EN] от AWS](https://github.com/eugeneyan/ml-design-docs) и [статья](https://eugeneyan.com/writing/ml-design-docs/) с объяснением каждого раздела  
> - [Верхнеуровневый шаблон ML System Design Doc от Google](https://towardsdatascience.com/the-undeniable-importance-of-design-docs-to-data-scientists-421132561f3c) и [описание общих принципов его заполнения](https://towardsdatascience.com/understanding-design-docs-principles-for-achieving-data-scientists-53e6d5ad6f7e).
> - [ML Design Template](https://www.mle-interviews.com/ml-design-template) от ML Engineering Interviews  
> - Статья [Design Documents for ML Models](https://medium.com/people-ai-engineering/design-documents-for-ml-models-bbcd30402ff7) на Medium. Верхнеуровневые рекомендации по содержанию дизайн-документа и объяснение, зачем он вообще нужен  
> - [Краткий Canvas для ML-проекта от Made with ML](https://madewithml.com/courses/mlops/design/#timeline). Подходит для верхнеуровневого описания идеи, чтобы понять, имеет ли смысл идти дальше.  
